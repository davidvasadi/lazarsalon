name: Deploy backend (CI build -> VPS)

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  #   paths:
  #     - "backend/**"
  #     - ".github/workflows/deploy-backend.yml"

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install & build Strapi (CI)
        working-directory: backend
        run: |
          npm ci
          npm run build

      - name: Create backend bundle (exclude uploads/env/tmp/node_modules)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf backend/node_modules || true

          tar -czf backend_bundle.tgz \
            --exclude='backend/public/uploads' \
            --exclude='backend/.env' \
            --exclude='backend/.env.*' \
            --exclude='backend/.tmp' \
            --exclude='backend/node_modules' \
            backend

      - name: Upload bundle to VPS via rsync
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

          rsync -avz --progress \
            -e "ssh -i key.pem -p 22 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            backend_bundle.tgz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/backend_bundle.tgz

      - name: Deploy on VPS (safe rsync + prod deps + pm2 restart)
        shell: bash
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

          ssh -i key.pem -p 22 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "set -euo pipefail \
            && APP_ROOT='/var/www/lazarsalon' \
            && BACKEND_DIR=\"\$APP_ROOT/backend\" \
            && STORAGE_UPLOADS='/var/www/lazarsalon_storage/uploads' \
            && STORAGE_DB='/var/www/lazarsalon_storage/db' \
            && TMP_DIR='/tmp/backend_deploy_${GITHUB_SHA}' \
            && mkdir -p \"\$TMP_DIR\" \
            && tar -xzf /tmp/backend_bundle.tgz -C \"\$TMP_DIR\" \
            && rm -f /tmp/backend_bundle.tgz \
            && mkdir -p /var/www/lazarsalon_storage \"\$STORAGE_UPLOADS\" \"\$STORAGE_DB\" \
            && mkdir -p \"\$BACKEND_DIR/public\" \"\$BACKEND_DIR/.tmp\" \
            && if [ ! -L \"\$BACKEND_DIR/public/uploads\" ]; then \
                 if [ -d \"\$BACKEND_DIR/public/uploads\" ]; then \
                   mv \"\$BACKEND_DIR/public/uploads\" \"/var/www/lazarsalon_storage/uploads_bak_\$(date +%F_%H%M%S)\"; \
                 fi; \
                 ln -s \"\$STORAGE_UPLOADS\" \"\$BACKEND_DIR/public/uploads\"; \
               fi \
            && mkdir -p \"\$STORAGE_DB\" \
            && touch \"\$STORAGE_DB/data.db\" \
            && chmod 600 \"\$STORAGE_DB/data.db\" || true \
            && ln -sfn \"\$STORAGE_DB/data.db\" \"\$BACKEND_DIR/.tmp/data.db\" \
            && rsync -a --delete \
                 --exclude 'public/uploads/' \
                 --exclude '.tmp/' \
                 --exclude '.env' \
                 --exclude '.env.*' \
                 --exclude 'node_modules' \
                 \"\$TMP_DIR/backend/\" \"\$BACKEND_DIR/\" \
            && rm -rf \"\$TMP_DIR\" \
            && cd \"\$BACKEND_DIR\" \
            && npm ci --omit=dev \
            && pm2 restart strapi"
