name: Deploy backend to VPS

on:
  push:
    branches: [ main ]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # Safety: never deploy if uploads isn't a symlink (protects customer uploads)
            if [ ! -L /var/www/lazarsalon/backend/public/uploads ]; then
              echo "ERROR: /var/www/lazarsalon/backend/public/uploads is not a symlink. Aborting deploy to protect uploads."
              exit 1
            fi

            cd /var/www/lazarsalon

            # Make working tree exactly match GitHub main
            git fetch origin main
            git reset --hard origin/main

            cd backend

            # Install dependencies
            npm ci

            # Strapi admin build can OOM on small VPS -> give Node more heap
            NODE_OPTIONS="--max-old-space-size=1536" npm run build

            # Restart Strapi
            pm2 restart strapi
